// An Interactive Topic Model of Signs. Except where noted, all source code, text, and graphics are copyright 2014 Andrew Goldstone, Susana Gal√°n, C. Laura Lovin, Andrew Mazzaschi, and Lindsey Whitmore.
"use strict";importScripts("utils.min.js");var my={},doc_topics_matrix,total_tokens,topic_docs,doc_topics,topic_yearly,yearly_total;doc_topics_matrix=function(t){var e={},s=t;if(s.p&&s.p.length){s.n=s.p.length-1}s.get=function(t,e){var s,a,i,r;if(!this.x){return undefined}if(t===undefined){return this}if(e===undefined){r=[];for(i=0;i<this.n;i+=1){r.push(this.get(t,i))}return r}s=this.p[e];a=utils.bisect_left(this.i.slice(s,this.p[e+1]),t);r=this.i[a+s]===t?this.x[a+s]:0;return r};s.row_sum=function(t){var s,a,i;if(!this.x){return undefined}if(!e.row_sum){e.row_sum=[]}if(t===undefined){for(a=0;a<this.n;a+=1){for(i=this.p[a];i<this.p[a+1];i+=1){if(e.row_sum[this.i[i]]===undefined){e.row_sum[this.i[i]]=0}e.row_sum[this.i[i]]+=this.x[i]}}return e.row_sum}if(!e.row_sum[t]){s=0;for(a=0;a<this.n;a+=1){s+=this.get(t,a)}e.row_sum[t]=s}return e.row_sum[t]};s.col_sum=function(t){var s;if(!e.col_sum){e.col_sum=[]}if(t===undefined){for(s=0;s<this.n;s+=1){this.col_sum(s)}return e.col_sum}if(!e.col_sum[t]){e.col_sum[t]=0;for(s=this.p[t];s<this.p[t+1];s+=1){e.col_sum[t]+=this.x[s]}}return e.col_sum[t]};return s};total_tokens=function(){var t,e=0;for(t=0;t<my.dt.x.length;t+=1){e+=my.dt.x[t]}return e};topic_docs=function(t,e){var s=my.dt.p[t],a=my.dt.p[t+1],i,r=[],o,d,n,c=[];for(i=s;i<a;i+=1){r.push({doc:my.dt.i[i],frac:my.dt.x[i]/my.dt.row_sum(my.dt.i[i]),weight:my.dt.x[i]})}if(e>=r.length){r.sort(function(t,e){return utils.desc(t.frac,e.frac)||utils.desc(t.doc,e.doc)});return r}c=r.slice(0,e).sort(function(t,e){return utils.asc(t.frac,e.frac)||utils.asc(t.doc,e.doc)});o=utils.bisector_left(function(t){return t.frac});for(n=e;n<r.length;n+=1){d=o(c,r[n].frac);if(d>0){c.splice(d,0,r[n]);c.shift()}else if(c[0].frac===r[n].frac){c.unshift(r[n])}}return utils.shorten(c.reverse(),e,function(t,e){return t[e].frac})};doc_topics=function(t,e){var s=[],a,i;for(a=0;a<my.dt.n;a+=1){i=my.dt.get(t,a);if(i>0){s.push({topic:a,weight:i})}}s.sort(function(t,e){return utils.desc(t.weight,e.weight)||utils.desc(t.t,e.t)});return utils.shorten(s,e,function(t,e){return t[e].weight})};topic_yearly=function(t){var e,s,a;if(!my.topic_yearly){my.topic_yearly=[]}if(t===undefined){e=[];for(s=0;s<my.dt.n;s+=1){e.push(topic_yearly(s))}return e}if(my.topic_yearly[t]){return my.topic_yearly[t]}e=[];for(s=my.dt.p[t];s<my.dt.p[t+1];s+=1){a=my.doc_years[my.dt.i[s]];if(e[a]){e[a]+=my.dt.x[s]}else{e[a]=my.dt.x[s]}}e.forEach(function(t,s){e[s]/=yearly_total(s)});my.topic_yearly[t]=e;return e};yearly_total=function(t){var e,s,a;if(!my.yearly_total){e=[];for(a=0;a<my.dt.i.length;a+=1){s=my.doc_years[my.dt.i[a]];if(e[s]){e[s]+=my.dt.x[a]}else{e[s]=my.dt.x[a]}}my.yearly_total=e}return isFinite(t)?my.yearly_total[t]:my.yearly_total};onmessage=function(t){if(t.data.what==="set_dt"){my.dt=doc_topics_matrix(t.data.dt);if(my.dt){my.dt.row_sum()}postMessage({what:"set_dt",result:my.dt!==undefined})}else if(t.data.what==="set_doc_years"){my.doc_years=t.data.doc_years;postMessage({what:"set_doc_years",result:my.doc_years!==undefined})}else if(t.data.what==="total_tokens"){postMessage({what:"total_tokens",result:total_tokens()})}else if(t.data.what==="topic_docs"){postMessage({what:"topic_docs/"+t.data.t+"/"+t.data.n,result:topic_docs(t.data.t,t.data.n)})}else if(t.data.what==="doc_topics"){postMessage({what:"doc_topics/"+t.data.d+"/"+t.data.n,result:doc_topics(t.data.d,t.data.n)})}else if(t.data.what==="topic_total"){postMessage({what:"topic_total/"+t.data.t,result:my.dt.col_sum(t.data.t==="all"?undefined:t.data.t)})}else if(t.data.what==="topic_yearly"){postMessage({what:"topic_yearly/"+t.data.t,result:topic_yearly(t.data.t==="all"?undefined:t.data.t)})}else if(t.data.what==="yearly_total"){postMessage({what:"yearly_total/"+t.data.y,result:yearly_total(t.data.y==="all"?undefined:t.data.y)})}else{postMessage({what:"error"})}};